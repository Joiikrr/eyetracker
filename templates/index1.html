<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Eye Tracking AAC</title>
    
    <link rel="stylesheet" type="text/css" href="{{url_for('static', filename='css/index1.css') }}">  
    
</head>
<body>
    <text>
            <div class = "textbox"> 
                    <h2 id="main">Welcome to the AAC</h2>
                    <p>x = <span id="ex">x</span> y = <span id="ey">y</span> </p>
            </div>
    </text>
   <grid>
        <div class="grid-container">
                <div class="grid-item"><button id="a" class="block" onclick="change('a')" type="button">A</button></div>
                <div class="grid-item"><button id="b" class="block" onclick="change('b')" type="button">B</button></div>
                <div class="grid-item"><button id="c" class="block" onclick="change('c')" type="button">C</button></div>
                <div class="grid-item"><button id="d" class="block" onclick="change('d')" type="button">D</button></div>
                <div class="grid-item"><button id="e" class="block" onclick="change('e')" type="button">E</button></div>
                <div class="grid-item"><button id="f" class="block" onclick="change('f')" type="button">F</button></div>
                <div class="grid-item"><button id="g" class="block" onclick="change('g')" type="button">G</button></div>
                <div class="grid-item"><button id="h" class="block" onclick="change('h')" type="button">H</button></div>
                <div class="grid-item"><button id="i" class="block" onclick="change('i')" type="button">I</button></div>
                <div class="grid-item"><button id="j" class="block" onclick="change('j')" type="button">J</button></div>
                <div class="grid-item"><button id="k" class="block" onclick="change('k')" type="button">K</button></div>
                <div class="grid-item"><button id="l" class="block" onclick="change('l')" type="button">L</button></div>
                <div class="grid-item"><button id="m" class="block" onclick="change('m')" type="button">M</button></div>
                <div class="grid-item"><button id="n" class="block" onclick="change('n')" type="button">N</button></div>
                <div class="grid-item"><button id="o" class="block" onclick="change('o')" type="button">O</button></div>
                <div class="grid-item"><button id="p" class="block" onclick="change('p')" type="button">P</button></div>
                <div class="grid-item"><button id="q" class="block" onclick="change('q')" type="button">Q</button></div>
                <div class="grid-item"><button id="r" class="block" onclick="change('r')" type="button">R</button></div>
                <div class="grid-item"><button id="s" class="block" onclick="change('s')" type="button">S</button></div>
                <div class="grid-item"><button id="t" class="block" onclick="change('t')" type="button">T</button></div>
                <div class="grid-item"><button id="u" class="block" onclick="change('u')" type="button">U</button></div>
                <div class="grid-item"><button id="v" class="block" onclick="change('v')" type="button">V</button></div>
                <div class="grid-item"><button id="w" class="block" onclick="change('w')" type="button">W</button></div>
                <div class="grid-item"><button id="x" class="block" onclick="change('x')" type="button">X</button></div>
                <div class="grid-item"><button id="y" class="block" onclick="change('y')" type="button">Y</button></div>
                <div class="grid-item"><button id="z" class="block" onclick="change('z')" type="button">Z</button></div>
                <div class="grid-item"></div>
                <div class="grid-item"><button class="block" onclick="recalibrate()" type="button">Recalibrate</button></div>
                <div class="grid-item"></div>
                <div class="grid-item"><button class="block" onclick="change('<=')" type="button">{=</button></div>
              </div>
    </grid>
    
        <video id="camera" height="480" width="640" ></video>
        <!-- <button class="block" onclick="sendframe()">Send</button> -->
        <canvas id="frame" height="480" width= "640"></canvas>
        <canvas id="eyeimg" height="480" width= "640"></canvas> 
        <canvas id="blurimg" height="480" width= "640"></canvas> 
        
    <!-- <script src="{{url_for('static', filename='js/keyboard.js')}}"></script> -->
    <script src="{{url_for('static', filename='js/socketjsio.js')}}"></script>>
    <script src="{{url_for('static', filename='js/jquery.js')}}" ></script>
    <script>
        var xCenter, yCenter, xTLeft, yTLeft, xBLeft, yBLeft, xBRight, yBRight, xTRight, yTRight
        var center, tleft, tright, bleft, bright = false
        var cal = 0;
        // calibrating bool variable needed for set interval
        function defaults(){ 

            let bcol = "#4CAF50"
            let col = "white"
            let m = document.getElementById('m')
            let a = document.getElementById("a")
            let e = document.getElementById("e")
            let u = document.getElementById("u")
            let y = document.getElementById('y')
            m.style.backgroundColor = bcol
            m.style.color = col
            a.style.backgroundColor = bcol
            a.style.color = col
            e.style.backgroundColor = bcol
            u.style.backgroundColor = bcol
            y.style.backgroundColor = bcol
            e.style.color = col
            u.style.color = col
            y.style.color = col 
            


        }

        function pressM(key){
            if(key.keyCode == "65"){
                console.log("pressed a")
                center = true;
               // console.log(center)
                xCenter = xEye
                yCenter = yEye
             console.log("M:", xCenter, yCenter)
        
                defaults()
                window.addEventListener("keydown", pressA)
                window.removeEventListener("keydown", pressM)
                document.getElementById('main').innerHTML = "Recalibration: Look at A then press A key"
                document.getElementById('a').style.color = "black"
                document.getElementById('a').style.backgroundColor = "#ddd"
                return;
            }
            
            //alert("space key pressed")
        }

        function pressA(key){
         //   window.removeEventListener("keydown", pressM)
            if(key.keyCode == 65 && center){
                tleft = true
                xTLeft = xEye;
                yTRight = yEye;
                console.log("A:", xTLeft, yTRight)

                defaults()
                window.addEventListener("keydown", pressE)
                window.removeEventListener("keydown", pressA)
                document.getElementById('main').innerHTML = "Recalibration: Look at E then press A key"
                document.getElementById('e').style.color = "black"
                document.getElementById('e').style.backgroundColor = "#ddd"


                return;
            }
            
           // alert("space key pressed 2")
           // window.removeEventListener("keydown", pressA)
        }

        function pressE(key){
            if(key.keyCode == 65 && tleft){
                tright = true;
                console.log(tright)
                xTRight = xEye
                yTRight = yEye
                console.log("E:", xTRight, yTRight)
            
                defaults()
                window.addEventListener("keydown", pressU)
                window.removeEventListener("keydown", pressE)
                document.getElementById('main').innerHTML = "Recalibration: Look at U then press A key"
                document.getElementById('u').style.color = "black"
                document.getElementById('u').style.backgroundColor = "#ddd"

                return;
            }
        }

        function pressU(key){
            if(key.keyCode == 65 && tright){
                bleft = true;
            //    console.log(bleft)
                xBLeft = xEye
                yBLeft = yEye
                console.log("U:", xBLeft, yBLeft)
            
                defaults()
                window.addEventListener("keydown", pressY)
                window.removeEventListener("keydown", pressU)
                document.getElementById('main').innerHTML = "Recalibration: Look at Y then press A key"
                document.getElementById('y').style.color = "black"
                document.getElementById('y').style.backgroundColor = "#ddd"

                return;
            }

        }

        function pressY(key){
            if(key.keyCode == 65 && bleft){
                bright = true;
                xBRight = xEye
                yBRight = yEye
                console.log("Y:", xBRight, yBRight)
            
                defaults()
               // window.addEventListener("keydown", pressU)
                window.removeEventListener("keydown", pressY)
                document.getElementById('main').innerHTML = "Done"
               // document.getElementById('y').style.color = "black"
                //document.getElementById('y').style.backgroundColor = "#ddd"

                return;
            }
            
        }

        function highlight(letter){
            defaults()
            document.getElementById(letter).style.backgroundColor = "#ddd"
            document.getElementById(letter).style.color = "black"
        }

        function recalibrate(){ // A - C - E -{ K - N - O -} U - W - Y 
         
            document.getElementById("main").innerHTML = "Recalibration: Look at M then press Space"
            document.getElementById("m").style.color = 'black'
            document.getElementById('m').style.backgroundColor = '#ddd'

            window.addEventListener("keydown", pressM)

            // S
        }

        function eyeKey(x,y){ //take current eye coords and map it to a letter and return change(letter)
            // map extreme coordinates to extreme keys
            let error = 1
            let letter
            if(x <= (xCenter + error) && x >= (xCenter - error) && y <= (yCenter + error) && y >= (yCenter -error)){
                letter = "m"
                highlight(letter)
            }     
            if(x <= (xTLeft + error) && x >= (xTLeft - error) && y <= (yTLeft + error) && y >= (yTLeft - error)){
                letter = 'a'
                highlight(letter)
            }
            if(x <= (xTRight + error) && x >= (xTRight - error) && y <= (yTRight + error) && y >= (yTRight - error)){
                letter = "e"
                highlight(letter)
            }
            if(x <= (xBLeft + error) && x >= (xBLeft - error) && y <= (yBLeft + error) && y>= (yBLeft - error)){
                letter = 'u'
                highlight(letter)
            }
            if(x <= (xBRight + error) && x>= (xBRight - error) && y <= (yBRight + error) && y>= (yBRight - error)){
                letter = 'y'
                highlight(letter)
            }

            return change(letter);
        }


        // KEYBOARD CODE//
        function change(letter){
            let tex = document.getElementById("main").innerHTML
            console.log(tex);
            let arr = tex.split("");
            console.log(arr);
            if(count === 0){
                arr=[];
                count++;
            }
            switch(letter){ //add all the hover attributes to style
                case 'a':
                    console.log('You pressed A');
                    arr.push('a');
                 //   console.log(arr);
                    break;
                case 'b':
                    arr.push('b');
                    break;
                case 'c': 
                    arr.push('c');
                    break;
                case 'd': 
                    arr.push('d');
                    break;
                case 'e': 
                    arr.push('e');
                    break;
                case 'f': 
                    arr.push('f');
                    break;
                case 'g': 
                    arr.push('g');
                    break; 
                case 'h': 
                    arr.push('h');
                    break;
                case 'i': 
                    arr.push('i');
                    break;
                case 'j': 
                    arr.push('j');
                    break;
                case 'k': 
                    arr.push('k');
                    break;
                case 'l':
                    arr.push('l');
                    break;
                case 'm': 
                    arr.push('m');
                    break;
                case 'n': 
                    arr.push('n');
                    break; 
                case 'o': 
                    arr.push('o');
                    break;
                case 'p': 
                    arr.push('p');
                    break;
                case 'q': 
                    arr.push('q');
                    break;
                case 'r':
                    arr.push('r');
                    break;
                case 's': 
                    arr.push('s');
                    break;
                case 't':
                    arr.push('t');
                    break;
                case 'u':
                    arr.push('u');
                    break;
                case 'v':
                    arr.push('v');
                    break;
                case 'w':
                    arr.push('w');
                    break;
                case 'x': 
                    arr.push('x');
                    break;
                case 'y': 
                    arr.push('y');
                    break;
                case 'z': 
                    arr.push('z');
                    break;    
                case '<=':
                    arr.pop();
                    break;
            }
            if(arr.length === 1){
            arr[0] = arr[0].toUpperCase();  
            }
            tex = arr.join("");
            console.log(tex);
            document.getElementById("main").innerHTML = tex;
        }
        var count = 0;
        // KEYBOARD CODE END // 

        // SOCKET IO CODE //
        var socket
        $(document).ready(function(){
            if (navigator.getUserMedia){
                console.log("True")
                navigator.getUserMedia({
                    audio: false,
                    video: true
                },success,failed)
            }
            else
                console.log("False")
    
            socket = io()
            // socket.emit("name", "My name is Joel")
            socket.on("response", function(xy){
                xEye = xy.x
                yEye = xy.y
                $('#ex').html(xy.x) 
                $('#ey').html(xy.y)
                var img = new Image();
                var eyeimage = document.getElementById("eyeimg")
                var canv = eyeimage.getContext('2d')
                img.onload = function(){canv.drawImage(img, 0, 0)}
                img.src = xy.blur

                var blurr = new Image();
                var blurimage = document.getElementById("blurimg")
                var canv2 = blurimage.getContext('2d')
                blurr.onload = function(){canv2.drawImage(blurr, 0, 0)}
                blurr.src = xy.img




            })
           
          // cam.play()
        })
        function success(stream){
            var cam = document.getElementById("camera")
            cam.srcObject = stream
            cam.play()
           // cam.onloadedmetadata = function(){cam.play}
        }
        function failed(error){
            alert(error)
        }
        function sendframe(){
            var cam = document.getElementById("camera")
            var canv = document.getElementById("frame")
            var context = canv.getContext("2d")
            context.drawImage(cam, 0, 0)
            var image = canv.toDataURL('image/jpeg', 1)
            console.log("Sending frame")
            socket.emit("frame", image)
        }
     setInterval(sendframe, 200)
       
    </script>
</body>
</html>